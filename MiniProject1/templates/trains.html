{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Welcome Section -->
    <div class="welcome-section mb-4">
        <h2>Welcome, {{ current_user.username }}!</h2>
        <p class="text-muted">Book your train tickets or manage your existing reservations.</p>
    </div>

    <!-- Existing Reservations Section -->
    <div class="existing-reservations mb-4">
        <h3>Your Reservations</h3>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>PNR</th>
                        <th>Train</th>
                        <th>Journey Date</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reservation in current_user.reservations %}
                    <tr>
                        <td>{{ reservation.pnr }}</td>
                        <td>{{ reservation.train.name }}</td>
                        <td>{{ reservation.journey_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ reservation.source_station }}</td>
                        <td>{{ reservation.destination_station }}</td>
                        <td>
                            <span class="badge {% if reservation.booking_status == 'CONFIRMED' %}bg-success{% else %}bg-warning{% endif %}">
                                {{ reservation.booking_status }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewReservationDetails('{{ reservation.pnr }}')">View</button>
                            <button class="btn btn-sm btn-danger" onclick="cancelReservation('{{ reservation.pnr }}')">Cancel</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Available Trains Section -->
    <div class="available-trains">
        <h3>Available Trains</h3>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Train Number</th>
                    <th>Train Name</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>AC Capacity</th>
                    <th>Non-AC Capacity</th>
                    <th>Base Fare</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for train in trains %}
                <tr data-train-id="{{ train.id }}">
                    <td>{{ train.id }}</td>
                    <td>{{ train.name }}</td>
                    <td>{{ train.source }}</td>
                    <td>{{ train.destination }}</td>
                    <td>{{ train.departure_time.strftime('%H:%M') }}</td>
                    <td>{{ train.arrival_time.strftime('%H:%M') }}</td>
                    <td>{{ train.ac_capacity }}</td>
                    <td>{{ train.nonac_capacity }}</td>
                    <td>₹{{ train.base_fare }}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showBookingModal('{{ train.id }}', '{{ train.name }}', '{{ train.source }}', '{{ train.destination }}')">
                            Book Tickets
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookingModalLabel">Book Train Tickets</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <input type="hidden" id="trainId" name="trainId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="trainName" class="form-label">Train Name</label>
                                <input type="text" class="form-control" id="trainName" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="journeyDate" class="form-label">Journey Date</label>
                                <input type="date" class="form-control" id="journeyDate" name="journeyDate" required min="{{ today_date }}" onchange="checkAvailability()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="departureTime" class="form-label">Departure Time</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                    <input type="text" class="form-control" id="departureTime" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="arrivalTime" class="form-label">Arrival Time</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                    <input type="text" class="form-control" id="arrivalTime" readonly>
                                </div>
                            </div>
                        </div>
                        <!-- Seat Availability Section -->
                        <div class="card mb-3" id="availabilityCard" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title">Seat Availability</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title text-primary">AC Coach</h6>
                                                <p class="mb-1">Total Seats: <span id="acTotalSeats">-</span></p>
                                                <p class="mb-1">Available: <span id="acAvailableSeats" class="text-success">-</span></p>
                                                <p class="mb-0">Fare: ₹<span id="acFare">-</span></p>
                                                <div class="seat-map mt-3" id="acSeatMap">
                                                    <div class="coach-label">AC Coach Layout</div>
                                                    <div class="seat-grid">
                                                        <!-- Seats will be added here dynamically -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title text-primary">Non-AC Coach</h6>
                                                <p class="mb-1">Total Seats: <span id="nonacTotalSeats">-</span></p>
                                                <p class="mb-1">Available: <span id="nonacAvailableSeats" class="text-success">-</span></p>
                                                <p class="mb-0">Fare: ₹<span id="nonacFare">-</span></p>
                                                <div class="seat-map mt-3" id="nonacSeatMap">
                                                    <div class="coach-label">Non-AC Coach Layout</div>
                                                    <div class="seat-grid">
                                                        <!-- Seats will be added here dynamically -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="seat-legend mt-2">
                                    <span class="seat-icon available"></span> Available
                                    <span class="seat-icon booked ms-3"></span> Booked
                                    <span class="seat-icon selected ms-3"></span> Selected
                                    <span class="seat-icon ladies ms-3"></span> Ladies
                                    <span class="seat-icon senior ms-3"></span> Senior Citizen
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="sourceStation" class="form-label">Source Station</label>
                                <select class="form-select" id="sourceStation" name="sourceStation" required>
                                    <option value="">Select Source Station</option>
                                    {% for station in stations %}
                                    <option value="{{ station.station_code }}">{{ station.station_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="destinationStation" class="form-label">Destination Station</label>
                                <select class="form-select" id="destinationStation" name="destinationStation" required>
                                    <option value="">Select Destination Station</option>
                                    {% for station in stations %}
                                    <option value="{{ station.station_code }}">{{ station.station_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="quota" class="form-label">Quota</label>
                                <select class="form-select" id="quota" name="quota" required>
                                    <option value="GENERAL">General</option>
                                    <option value="TATKAL">Tatkal</option>
                                    <option value="LADIES">Ladies</option>
                                    <option value="SENIOR_CITIZEN">Senior Citizen</option>
                                    <option value="DIVYANG">Divyang</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Additional Features</label>
                                <div class="form-check">
                                    <input class="form-check-input feature-checkbox" type="checkbox" value="SLEEPER" id="featureSleeper">
                                    <label class="form-check-label" for="featureSleeper">Sleeper (₹200)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input feature-checkbox" type="checkbox" value="WIFI" id="featureWifi">
                                    <label class="form-check-label" for="featureWifi">WiFi (₹50)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input feature-checkbox" type="checkbox" value="PANTRY" id="featurePantry">
                                    <label class="form-check-label" for="featurePantry">Pantry (₹75)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input feature-checkbox" type="checkbox" value="MEALS" id="featureMeals">
                                    <label class="form-check-label" for="featureMeals">Meals (₹150)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input feature-checkbox" type="checkbox" value="ENTERTAINMENT" id="featureEntertainment">
                                    <label class="form-check-label" for="featureEntertainment">Entertainment (₹50)</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h5>Passengers</h5>
                            <div id="passengersContainer">
                                <!-- Passenger forms will be added here -->
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addPassenger()">Add Passenger</button>
                        </div>
                        <div class="mb-3">
                            <h5>Fare Summary</h5>
                            <div class="card">
                                <div class="card-body">
                                    <p>Base Fare: ₹<span id="baseFare">0.00</span></p>
                                    <p>Features: ₹<span id="featuresFare">0.00</span></p>
                                    <p>Total Passengers: <span id="totalPassengers">0</span></p>
                                    <h6>Total Fare: ₹<span id="totalFare">0.00</span></h6>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h5>Journey Summary</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>From:</strong> <span id="summarySource"></span></p>
                                            <p><strong>Departure:</strong> <span id="summaryDeparture"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>To:</strong> <span id="summaryDestination"></span></p>
                                            <p><strong>Arrival:</strong> <span id="summaryArrival"></span></p>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <p><strong>Journey Date:</strong> <span id="summaryDate"></span></p>
                                            <p><strong>Duration:</strong> <span id="summaryDuration"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="console.log('Button clicked!'); submitBooking();">Confirm Booking</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTrainId = null;
let baseFare = 0;
let isAcCoach = false;

const AGE_REQUIREMENTS = {
    INFANT_AGE: 2,
    FREE_TICKET_AGE: 5,
    CHILD_AGE: 12,
    MIN_SOLO_AGE: 16,
    ADULT_AGE: 18
};

function formatTimeDisplay(timeString) {
    if (!timeString) return 'Not available';
    
    // Remove any extra whitespace
    timeString = timeString.trim();
    
    try {
        // First, try to parse the time string into hours and minutes
        let hours, minutes;
        
        if (timeString.includes(':')) {
            // Handle HH:MM format
            [hours, minutes] = timeString.split(':').map(Number);
        } else if (timeString.length === 4) {
            // Handle HHMM format
            hours = parseInt(timeString.substring(0, 2));
            minutes = parseInt(timeString.substring(2));
        } else {
            throw new Error('Invalid time format');
        }
        
        // Validate hours and minutes
        if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
            throw new Error('Invalid time values');
        }
        
        // Convert to 12-hour format
        const period = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        
        // Format the time string
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${period}`;
    } catch (error) {
        console.error('Time parsing error:', error);
        return 'Invalid time';
    }
}

function formatTo12Hour(hours, minutes) {
    try {
        // Validate input
        hours = parseInt(hours);
        minutes = parseInt(minutes);
        
        if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
            throw new Error('Invalid time values');
        }
        
        const period = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${period}`;
    } catch (error) {
        console.error('Time formatting error:', error);
        return 'Invalid time';
    }
}

function showBookingModal(trainId, trainName, source, destination) {
    console.log('showBookingModal called for trainId:', trainId); // Log function start
    currentTrainId = trainId;
    
    // Reset the form and clear any previous data
    document.getElementById('bookingForm').reset();
    document.getElementById('passengersContainer').innerHTML = '';
    document.getElementById('trainId').value = trainId;
    document.getElementById('trainName').value = trainName;
    
    // Pre-select source and destination stations
    document.getElementById('sourceStation').value = source;
    document.getElementById('destinationStation').value = destination;
    
    // Reset fare display
    document.getElementById('baseFare').textContent = '0.00';
    document.getElementById('featuresFare').textContent = '0.00';
    document.getElementById('totalPassengers').textContent = '0';
    document.getElementById('totalFare').textContent = '0.00';
    
    // Hide availability card until date is selected
    const availabilityCard = document.getElementById('availabilityCard');
    if (availabilityCard) {
        availabilityCard.style.display = 'none';
    }
    
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info';
    loadingDiv.id = 'loadingAlert';
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading train details...';
    document.querySelector('.modal-body').insertBefore(loadingDiv, document.getElementById('bookingForm'));
    
    // Fetch train details including departure and arrival times
    console.log('Fetching train details for trainId:', trainId); // Log before fetch
    fetch(`/api/train/${trainId}`)
        .then(response => {
            console.log('Fetch response received. Status:', response.status); // Log response status
            if (!response.ok) {
                // Attempt to read response body even if not OK for better error info
                return response.json().catch(() => { 
                    // If response is not JSON, just throw with status
                throw new Error(`HTTP error! status: ${response.status}`);
                }).then(data => {
                    console.error('Error response data:', data); // Log error response data
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Train details fetched successfully:', data); // Log successful data
            if (data.success && data.train) {
                baseFare = data.train.fare;
                document.getElementById('baseFare').textContent = baseFare.toFixed(2);
                
                // Get the departure and arrival times from the table row
                const trainRow = document.querySelector(`tr[data-train-id="${trainId}"]`);
                if (trainRow) {
                    const departureTime = trainRow.querySelector('td:nth-child(5)').textContent;
                    const arrivalTime = trainRow.querySelector('td:nth-child(6)').textContent;
                    
                    // Format and display the times
                    const formattedDeparture = formatTimeDisplay(departureTime);
                    const formattedArrival = formatTimeDisplay(arrivalTime);
                    
                    document.getElementById('departureTime').value = formattedDeparture;
                    document.getElementById('arrivalTime').value = formattedArrival;
                    
                    // Update summary fields
                    document.getElementById('summaryDeparture').textContent = formattedDeparture;
                    document.getElementById('summaryArrival').textContent = formattedArrival;
                }
                
                // Update journey summary
                updateJourneySummary();
                calculateTotalFare();
                
                // Remove loading indicator
                const loadingAlert = document.getElementById('loadingAlert');
                if (loadingAlert) {
                    loadingAlert.remove();
                }
                
                // Enable the form (assuming it was hidden initially or needs re-enabling)
                document.getElementById('bookingForm').style.display = 'block';

                // Show the modal
                console.log('Showing booking modal.'); // Log before showing modal
                const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
                modal.show();

            } else {
                throw new Error(data.message || 'Error fetching train details: success false');
            }
        })
        .catch(error => {
            console.error('Error in showBookingModal fetch:', error); // Log any errors
            // Show error message in modal area
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message || 'Error loading train details. Please try again.'}`;
            // Insert error message before the form or where the loading indicator was
            const loadingAlert = document.getElementById('loadingAlert');
            if (loadingAlert) {
                loadingAlert.replaceWith(errorDiv); // Replace loading with error
            } else {
                 document.querySelector('.modal-body').insertBefore(errorDiv, document.getElementById('bookingForm'));
            }
             // Ensure form is hidden or disabled if there's an error
            document.getElementById('bookingForm').style.display = 'none';

        });
    
}

function checkAvailability() {
    const journeyDate = document.getElementById('journeyDate').value;
    if (!journeyDate) {
        alert('Please select a journey date first');
        return;
    }

    // Show loading state
    document.getElementById('availabilityCard').style.display = 'none';
    
    fetch(`/api/seat-availability/${currentTrainId}/${journeyDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const availability = data.availability;
                
                // Update AC coach information
                document.getElementById('acTotalSeats').textContent = availability.ac.total_capacity;
                document.getElementById('acAvailableSeats').textContent = availability.ac.available_seats;
                document.getElementById('acFare').textContent = (baseFare + 300).toFixed(2);
                
                // Update Non-AC coach information
                document.getElementById('nonacTotalSeats').textContent = availability.nonac.total_capacity;
                document.getElementById('nonacAvailableSeats').textContent = availability.nonac.available_seats;
                document.getElementById('nonacFare').textContent = baseFare.toFixed(2);
                
                // Generate seat maps
                generateSeatMap('acSeatMap', availability.ac);
                generateSeatMap('nonacSeatMap', availability.nonac);
                
                // Show the availability card
                document.getElementById('availabilityCard').style.display = 'block';
                
                // Update coach selection for existing passengers
                updatePassengerCoachOptions(availability);
            } else {
                console.error('Error:', data.message);
                alert(data.message || 'Error fetching seat availability. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error fetching seat availability. Please try again.');
        });
}

function generateSeatMap(containerId, coachData) {
    const seatGrid = document.querySelector(`#${containerId} .seat-grid`);
    seatGrid.innerHTML = '';
    
    const seats = coachData.seats || {};
    const totalSeats = coachData.total_capacity;
    
    // Create seat rows (6 seats per row)
    for (let i = 1; i <= totalSeats; i++) {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.dataset.seatNumber = i;
        seat.textContent = i;
        
        const seatInfo = seats[i] || { status: 'available', type: null };
        if (seatInfo.status === 'booked') {
            seat.classList.add('booked');
            if (seatInfo.type === 'ladies') {
                seat.classList.add('ladies');
            } else if (seatInfo.type === 'senior') {
                seat.classList.add('senior');
            }
        } else {
            seat.classList.add('available');
            seat.onclick = () => selectSeat(seat, containerId);
        }
        
        // Add tooltip with seat information
        let tooltipText = `Seat ${i}`;
        if (seatInfo.status === 'booked') {
            tooltipText += ' - Booked';
            if (seatInfo.type) {
                tooltipText += ` (${seatInfo.type === 'ladies' ? 'Ladies' : 'Senior Citizen'})`;
            }
        }
        seat.title = tooltipText;
        
        seatGrid.appendChild(seat);
        
        // Add aisle gap after every 3 seats
        if (i % 6 === 3) {
            const aisle = document.createElement('div');
            aisle.className = 'aisle';
            seatGrid.appendChild(aisle);
        }
    }
}

function selectSeat(seatElement, coachType) {
    if (seatElement.classList.contains('booked')) {
        alert('This seat is already booked.');
        return;
    }
    
    const isAC = coachType === 'acSeatMap';
    const passengerCards = document.querySelectorAll('.passenger-card');
    let assigned = false;
    
    // Find first passenger without a seat in the same coach type
    for (const card of passengerCards) {
        const coachSelect = card.querySelector('.coach-select');
        const seatInput = card.querySelector('.seat-number');
        
        if (coachSelect.value === (isAC ? 'AC' : 'NONAC') && !seatInput.value) {
            const seatNumber = seatElement.dataset.seatNumber;
            
            // First, remove any previous selections for this passenger
            const previousSelection = document.querySelector('.seat.selected[data-passenger-id="' + card.dataset.passengerId + '"]');
            if (previousSelection) {
                previousSelection.classList.remove('selected');
                previousSelection.removeAttribute('data-passenger-id');
            }
            
            // Assign the new seat
            seatInput.value = seatNumber;
            seatElement.classList.add('selected');
            seatElement.dataset.passengerId = card.dataset.passengerId;
            
            // Update seat status in UI
            updateSeatStatus(card, seatNumber, isAC);
            
            // Mark as assigned
            assigned = true;
            
            // Update total fare
            calculateTotalFare();
            break;
        }
    }
    
    if (!assigned) {
        if (passengerCards.length === 0) {
            alert('Please add a passenger first.');
        } else {
            alert('Please select a coach type for the passenger before selecting a seat.');
        }
    }
}

function updateSeatStatus(passengerCard, seatNumber, isAC) {
    const seatInfo = document.createElement('div');
    seatInfo.className = 'seat-info mt-2';
    seatInfo.innerHTML = `
        <span class="badge bg-primary">
            ${isAC ? 'AC' : 'Non-AC'} Coach - Seat ${seatNumber}
        </span>
        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearSeatSelection(this)">
            Clear Selection
        </button>
    `;
    
    const existingSeatInfo = passengerCard.querySelector('.seat-info');
    if (existingSeatInfo) {
        existingSeatInfo.replaceWith(seatInfo);
    } else {
        passengerCard.querySelector('.card-body').appendChild(seatInfo);
    }
}

function clearSeatSelection(button) {
    const passengerCard = button.closest('.passenger-card');
    const seatInput = passengerCard.querySelector('.seat-number');
    const seatNumber = seatInput.value;
    const coachType = passengerCard.querySelector('.coach-select').value;
    
    // Find and unmark the selected seat
    const seatMap = document.querySelector(`#${coachType === 'AC' ? 'acSeatMap' : 'nonacSeatMap'} .seat-grid`);
    const selectedSeat = seatMap.querySelector(`.seat[data-seat-number="${seatNumber}"]`);
    if (selectedSeat) {
        selectedSeat.classList.remove('selected');
        selectedSeat.removeAttribute('data-passenger-id');
    }
    
    // Clear the seat number input
    seatInput.value = '';
    
    // Remove the seat info display
    const seatInfo = passengerCard.querySelector('.seat-info');
    if (seatInfo) {
        seatInfo.remove();
    }
    
    // Update total fare
    calculateTotalFare();
}

function updatePassengerCoachOptions(availability) {
    const passengerCards = document.querySelectorAll('.passenger-card');
    passengerCards.forEach(card => {
        const coachSelect = card.querySelector('.coach-select');
        if (coachSelect) {
            const acOption = coachSelect.querySelector('option[value="AC"]');
            const nonacOption = coachSelect.querySelector('option[value="NONAC"]');
            
            // Disable options if no seats available
            acOption.disabled = availability.ac.available_seats <= 0;
            nonacOption.disabled = availability.nonac.available_seats <= 0;
            
            // Add availability info to options
            acOption.textContent = `AC Coach (${availability.ac.available_seats} available)`;
            nonacOption.textContent = `Non-AC Coach (${availability.nonac.available_seats} available)`;
        }
    });
}

function addPassenger() {
    const container = document.getElementById('passengersContainer');
    const passengerCount = container.children.length + 1;
    
    const passengerForm = document.createElement('div');
    passengerForm.className = 'card mb-3 passenger-card';
    passengerForm.innerHTML = `
        <div class="card-body">
            <h6>Passenger ${passengerCount}</h6>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-control" name="firstName[]" required>
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-control" name="lastName[]" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="email[]" required>
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" name="phone[]" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label class="form-label">Date of Birth</label>
                    <input type="date" class="form-control passenger-dob" name="dob[]" required onchange="validateAge(this)">
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label">Gender</label>
                    <select class="form-select" name="gender[]" required>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2">
                    <label class="form-label">Coach Type</label>
                    <select class="form-select coach-select" name="coachType[]" required onchange="updatePassengerFare(this)">
                        <option value="">Select Coach</option>
                        <option value="AC">AC Coach</option>
                        <option value="NONAC">Non-AC Coach</option>
                    </select>
                </div>
            </div>
            <div class="text-end">
                <button type="button" class="btn btn-danger btn-sm" onclick="removePassenger(this)">Remove</button>
            </div>
        </div>
    `;
    
    container.appendChild(passengerForm);
    updatePassengerCount();
    calculateTotalFare();
    
    // Check availability if date is selected
    if (document.getElementById('journeyDate').value) {
        checkAvailability();
    }
    
    // Add seat number input to the passenger form
    const seatNumberInput = document.createElement('input');
    seatNumberInput.type = 'hidden';
    seatNumberInput.className = 'seat-number';
    seatNumberInput.name = 'seatNumber[]';
    passengerForm.querySelector('.card-body').appendChild(seatNumberInput);
}

function updatePassengerFare(select) {
    const isAc = select.value === 'AC';
    const passengerCard = select.closest('.passenger-card');
    const fareDisplay = passengerCard.querySelector('.passenger-fare');
    
    if (!fareDisplay) {
        const fareElement = document.createElement('p');
        fareElement.className = 'passenger-fare mt-2 mb-0';
        passengerCard.querySelector('.card-body').appendChild(fareElement);
    }
    
    calculateTotalFare();
}

function calculateAge(dateOfBirth) {
    const dob = new Date(dateOfBirth);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    return age;
}

function validateAge(row) {
    const passengerCard = row.closest('.passenger-card');
    const dobInput = passengerCard.querySelector('[name="dob[]"]');
    const age = calculateAge(dobInput.value);
    const ageBadge = passengerCard.querySelector('.age-badge');
    
    if (!ageBadge) {
        const badgeContainer = document.createElement('div');
        badgeContainer.className = 'mt-2';
        badgeContainer.innerHTML = `<span class="badge age-badge"></span>`;
        dobInput.parentElement.appendChild(badgeContainer);
    }
    
    const badge = passengerCard.querySelector('.age-badge');
    
    // Remove any existing status messages
    const existingStatus = passengerCard.querySelector('.age-status');
    if (existingStatus) {
        existingStatus.remove();
    }
    
    // Create status message container
    const statusDiv = document.createElement('div');
    statusDiv.className = 'age-status mt-2';
    
    if (age <= AGE_REQUIREMENTS.FREE_TICKET_AGE) {
        badge.className = 'badge bg-success age-badge';
        badge.textContent = 'Free Ticket (Age ≤ 5)';
        passengerCard.classList.add('free-ticket');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> This passenger is eligible for a free ticket.
                Must be accompanied by a passenger aged 18 or above.
            </div>`;
    } else if (age <= AGE_REQUIREMENTS.CHILD_AGE) {
        badge.className = 'badge bg-info age-badge';
        badge.textContent = 'Child Fare (50% off)';
        passengerCard.classList.remove('free-ticket');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> This passenger is eligible for a 50% discount.
                Must be accompanied by a passenger aged 18 or above.
            </div>`;
    } else if (age < AGE_REQUIREMENTS.MIN_SOLO_AGE) {
        badge.className = 'badge bg-warning age-badge';
        badge.textContent = 'Minor - Requires Adult Guardian';
        passengerCard.classList.remove('free-ticket');
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> This passenger must be accompanied by at least one passenger aged 18 or above.
            </div>`;
    } else if (age >= 60) {
        badge.className = 'badge bg-warning age-badge';
        badge.textContent = 'Senior Citizen (30% off)';
        passengerCard.classList.remove('free-ticket');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> This passenger is eligible for a 30% senior citizen discount.
            </div>`;
    } else {
        badge.className = 'badge bg-primary age-badge';
        badge.textContent = age >= AGE_REQUIREMENTS.ADULT_AGE ? 'Adult' : 'Teen';
        passengerCard.classList.remove('free-ticket');
        if (age >= AGE_REQUIREMENTS.ADULT_AGE) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Adult passenger - Can accompany minors.
                </div>`;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Teen passenger - Can travel independently.
                </div>`;
        }
    }
    
    dobInput.parentElement.appendChild(statusDiv);
    validatePassengers();
    calculateTotalFare();
}

function validatePassengers() {
    const passengers = Array.from(document.querySelectorAll('.passenger-card')).map(card => {
        const dobInput = card.querySelector('[name="dob[]"]');
        const age = calculateAge(dobInput.value);
        return { age, element: card };
    });
    
    const hasAdult = passengers.some(p => p.age >= AGE_REQUIREMENTS.ADULT_AGE);
    const minorsWithoutGuardian = passengers.filter(p => p.age < AGE_REQUIREMENTS.MIN_SOLO_AGE);
    
    // Remove any existing validation messages
    document.querySelectorAll('.validation-message').forEach(msg => msg.remove());
    
    if (minorsWithoutGuardian.length > 0) {
        if (!hasAdult) {
            // Add visual feedback for minor passengers
            minorsWithoutGuardian.forEach(p => {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-danger mt-2 validation-message';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Adult Guardian Required:</strong> Passengers under ${AGE_REQUIREMENTS.MIN_SOLO_AGE} must be accompanied by at least one passenger over ${AGE_REQUIREMENTS.ADULT_AGE} years old.
                `;
                
                p.element.querySelector('.card-body').appendChild(warningDiv);
            });
            
            // Add a summary message at the top of the form
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'alert alert-danger validation-message';
            summaryDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Booking Cannot Proceed:</strong> You have ${minorsWithoutGuardian.length} passenger(s) under ${AGE_REQUIREMENTS.MIN_SOLO_AGE} years old who require an adult guardian.
                Please add at least one passenger aged ${AGE_REQUIREMENTS.ADULT_AGE} or above.
            `;
            document.getElementById('passengersContainer').insertBefore(summaryDiv, document.getElementById('passengersContainer').firstChild);
            
            return false;
        } else {
            // Add a positive confirmation message
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'alert alert-success validation-message';
            confirmationDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <strong>Adult Guardian Present:</strong> All minor passengers are properly accompanied by an adult.
            `;
            document.getElementById('passengersContainer').insertBefore(confirmationDiv, document.getElementById('passengersContainer').firstChild);
        }
    }
    
    return true;
}

function calculateTotalFare() {
    const passengerCards = document.querySelectorAll('.passenger-card');
    let totalFare = 0;
    let payingPassengers = 0;
    let freePassengers = 0;
    
    passengerCards.forEach(card => {
        const coachSelect = card.querySelector('.coach-select');
        const dobInput = card.querySelector('[name="dob[]"]');
        const age = calculateAge(dobInput.value);
        
        if (age <= 5) {
            freePassengers++;
            // Free ticket for children 5 and under
            return;
        }
        
        payingPassengers++;
        let passengerFare = baseFare;
        
        // Add AC charge if applicable
        if (coachSelect.value === 'AC') {
            passengerFare += 300;
        }
        
        // Apply age-based discounts
        if (age <= 12) {
            passengerFare *= 0.5; // 50% off for children 6-12
        } else if (age >= 60) {
            passengerFare *= 0.7; // 30% off for seniors
        }
        
        // Add feature prices
        const selectedFeatures = Array.from(document.querySelectorAll('.feature-checkbox:checked'));
        selectedFeatures.forEach(feature => {
            passengerFare += parseFloat(feature.getAttribute('data-price'));
        });
        
        totalFare += passengerFare;
    });
    
    // Update fare summary
    document.getElementById('baseFare').textContent = `₹${baseFare.toFixed(2)}`;
    document.getElementById('featuresFare').textContent = `₹${calculateFeatureTotal().toFixed(2)}`;
    document.getElementById('totalPassengers').textContent = `${payingPassengers} (+ ${freePassengers} free)`;
    document.getElementById('totalFare').textContent = `₹${totalFare.toFixed(2)}`;
}

function calculateFeatureTotal() {
    const selectedFeatures = Array.from(document.querySelectorAll('.feature-checkbox:checked'));
    let total = 0;
    selectedFeatures.forEach(feature => {
        total += parseFloat(feature.getAttribute('data-price'));
    });
    return total;
}

function removePassenger(button) {
    button.closest('.passenger-card').remove();
    updatePassengerCount();
    calculateTotalFare();
}

function updatePassengerCount() {
    const count = document.getElementById('passengersContainer').children.length;
    document.getElementById('totalPassengers').textContent = count;
}

function submitBooking() {
    console.log('submitBooking function called.');
    // Disable the submit button to prevent double submission
    const submitButton = document.querySelector('.modal-footer .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

    try {
        // Clear any previous error messages
        const existingErrors = document.querySelectorAll('.booking-error');
        existingErrors.forEach(error => error.remove());

        // Validate journey date
        const journeyDate = document.getElementById('journeyDate').value;
        if (!journeyDate) {
            throw new Error('Please select a journey date');
        }

        // Validate source and destination
        const sourceStation = document.getElementById('sourceStation').value;
        const destinationStation = document.getElementById('destinationStation').value;
        if (!sourceStation || !destinationStation) {
            throw new Error('Please select both source and destination stations');
        }

        if (sourceStation === destinationStation) {
            throw new Error('Source and destination stations cannot be the same');
        }

        // Validate passengers
        const passengerCards = document.querySelectorAll('.passenger-card');
        if (passengerCards.length === 0) {
            throw new Error('Please add at least one passenger');
        }

        if (!validatePassengers()) {
            throw new Error('Please ensure all passengers meet the age requirements');
        }

        const formData = {
            train_id: currentTrainId,
            journey_date: journeyDate,
            source_station: sourceStation,
            destination_station: destinationStation,
            departure_time: document.getElementById('departureTime').value,
            arrival_time: document.getElementById('arrivalTime').value,
            quota_id: document.getElementById('quota').value,
            selected_features: Array.from(document.querySelectorAll('.feature-checkbox:checked')).map(cb => cb.value),
            passengers: []
        };

        // Validate and collect passenger data
        passengerCards.forEach((card, index) => {
            const firstName = card.querySelector('[name="firstName[]"]').value.trim();
            const lastName = card.querySelector('[name="lastName[]"]').value.trim();
            const email = card.querySelector('[name="email[]"]').value.trim();
            const phone = card.querySelector('[name="phone[]"]').value.trim();
            const dob = card.querySelector('[name="dob[]"]').value;
            const gender = card.querySelector('[name="gender[]"]').value;
            const coachType = card.querySelector('[name="coachType[]"]').value;
            const seatNumber = card.querySelector('.seat-number').value;

            // Validate required fields
            if (!firstName || !lastName || !email || !phone || !dob || !gender || !coachType) {
                throw new Error(`Please fill in all required fields for Passenger ${index + 1}`);
            }

            // Validate seat selection
            if (!seatNumber) {
                throw new Error(`Please select a seat for Passenger ${index + 1}`);
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                throw new Error(`Please enter a valid email address for Passenger ${index + 1}`);
            }

            // Validate phone number
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(phone)) {
                throw new Error(`Please enter a valid 10-digit phone number for Passenger ${index + 1}`);
            }

            formData.passengers.push({
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: phone,
                date_of_birth: dob,
                gender: gender,
                coach_type: coachType,
                seat_number: seatNumber,
                fare: calculatePassengerFare(card)
            });
        });

        // Make the API call
        console.log('Booking data:', formData); // Log the data being sent
        fetch('/create_reservation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('Response status:', response.status); // Log the response status
            if (!response.ok) {
                return response.json().then(data => {
                    console.error('Error response data:', data); // Log error response data
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response data:', data); // Log success response data
            if (data.success) {
                // Show success message before redirecting
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success';
                successDiv.innerHTML = '<i class="fas fa-check-circle"></i> Booking successful! Redirecting to confirmation page...';
                document.querySelector('.modal-body').insertBefore(successDiv, document.getElementById('bookingForm'));
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = `/booking-success/${data.pnr}`;
                }, 1500);
            } else {
                throw new Error(data.message || 'Booking failed. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message || 'An error occurred while processing your booking. Please try again.');
        })
        .finally(() => {
            // Reset button state
            submitButton.disabled = false;
            submitButton.innerHTML = 'Confirm Booking';
        });

    } catch (error) {
        console.error('Error:', error);
        showError(error.message);
        submitButton.disabled = false;
        submitButton.innerHTML = 'Confirm Booking';
    }
}

function showError(message) {
    // Remove any existing error messages
    const existingErrors = document.querySelectorAll('.booking-error');
    existingErrors.forEach(error => error.remove());

    // Create and show new error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger booking-error';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    document.querySelector('.modal-body').insertBefore(errorDiv, document.getElementById('bookingForm'));

    // Scroll to error message
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function calculatePassengerFare(passengerCard) {
    const age = calculateAge(passengerCard.querySelector('[name="dob[]"]').value);
    const coachType = passengerCard.querySelector('[name="coachType[]"]').value;
    
    // Free ticket for children 5 and under
    if (age <= AGE_REQUIREMENTS.FREE_TICKET_AGE) {
        return 0;
    }
    
    let fare = baseFare;
    
    // Add AC charge if applicable
    if (coachType === 'AC') {
        fare += 300;
    }
    
    // Apply age-based discounts
    if (age <= AGE_REQUIREMENTS.CHILD_AGE) {
        fare *= 0.5; // 50% off for children 6-12
    } else if (age >= 60) {
        fare *= 0.7; // 30% off for seniors
    }
    
    // Add feature prices
    const selectedFeatures = Array.from(document.querySelectorAll('.feature-checkbox:checked'));
    selectedFeatures.forEach(feature => {
        fare += parseFloat(feature.getAttribute('data-price') || 0);
    });
    
    return fare;
}

// Add this helper function for feature prices
const featurePrices = {
    'SLEEPER': 200,
    'WIFI': 50,
    'PANTRY': 75,
    'MEALS': 150,
    'ENTERTAINMENT': 50
};

// Update the feature checkboxes to include prices
document.querySelectorAll('.feature-checkbox').forEach(checkbox => {
    const price = featurePrices[checkbox.value];
    if (price) {
        checkbox.setAttribute('data-price', price);
    }
});

// Update the form HTML to include departure and arrival time fields
document.addEventListener('DOMContentLoaded', function() {
    const timeFields = document.createElement('div');
    timeFields.className = 'row mb-3';
    timeFields.innerHTML = `
        <div class="col-md-6">
            <label class="form-label">Departure Time</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-clock"></i></span>
                <input type="text" class="form-control" id="departureTime" readonly style="background-color: #fff;">
            </div>
        </div>
        <div class="col-md-6">
            <label class="form-label">Arrival Time</label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-clock"></i></span>
                <input type="text" class="form-control" id="arrivalTime" readonly style="background-color: #fff;">
            </div>
        </div>
    `;
    
    const trainDetailsRow = document.querySelector('#bookingForm .row:first-child');
    if (trainDetailsRow) {
        trainDetailsRow.insertAdjacentElement('afterend', timeFields);
    }
});

// Update the journey summary function to handle formatted times
function updateJourneySummary() {
    const journeyDate = document.getElementById('journeyDate').value;
    const sourceStation = document.getElementById('sourceStation');
    const destinationStation = document.getElementById('destinationStation');
    const departureTime = document.getElementById('departureTime').value;
    const arrivalTime = document.getElementById('arrivalTime').value;

    // Format the date
    const formattedDate = journeyDate ? new Date(journeyDate).toLocaleDateString('en-IN', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }) : '';

    // Update summary fields
    document.getElementById('summarySource').textContent = sourceStation.options[sourceStation.selectedIndex]?.text || '';
    document.getElementById('summaryDestination').textContent = destinationStation.options[destinationStation.selectedIndex]?.text || '';
    document.getElementById('summaryDeparture').textContent = departureTime || 'Not available';
    document.getElementById('summaryArrival').textContent = arrivalTime || 'Not available';
    document.getElementById('summaryDate').textContent = formattedDate || 'Not selected';

    // Calculate and display journey duration if both times are available
    if (departureTime && arrivalTime) {
        const duration = calculateJourneyDuration(departureTime, arrivalTime);
        document.getElementById('summaryDuration').textContent = duration;
    } else {
        document.getElementById('summaryDuration').textContent = 'Not available';
    }
}

// Update the journey duration calculation to handle 12-hour format
function calculateJourneyDuration(departureTime, arrivalTime) {
    // Convert 12-hour format to 24-hour for calculation
    const convertTo24Hour = (time12h) => {
        const [time, modifier] = time12h.split(' ');
        let [hours, minutes] = time.split(':');
        hours = parseInt(hours);
        minutes = parseInt(minutes);
        
        if (hours === 12) {
            hours = modifier === 'PM' ? 12 : 0;
        } else if (modifier === 'PM') {
            hours = hours + 12;
        }
        
        return [hours, minutes];
    };
    
    const [depHours, depMinutes] = convertTo24Hour(departureTime);
    const [arrHours, arrMinutes] = convertTo24Hour(arrivalTime);
    
    let durationMinutes = (arrHours * 60 + arrMinutes) - (depHours * 60 + depMinutes);
    if (durationMinutes < 0) {
        durationMinutes += 24 * 60; // Add 24 hours if arrival is next day
    }
    
    const hours = Math.floor(durationMinutes / 60);
    const minutes = durationMinutes % 60;
    
    return `${hours} hr${hours !== 1 ? 's' : ''} ${minutes} min${minutes !== 1 ? 's' : ''}`;
}

// Add event listeners for journey summary updates
document.addEventListener('DOMContentLoaded', function() {
    const updateTriggers = ['journeyDate', 'sourceStation', 'destinationStation'];
    updateTriggers.forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateJourneySummary);
    });

    // Add click listener to modal footer for debugging
    const modalFooter = document.querySelector('#bookingModal .modal-footer');
    if (modalFooter) {
        modalFooter.addEventListener('click', function(event) {
            console.log('Click registered in modal footer.', event.target);
        });
    }
});

function viewReservationDetails(pnr) {
    // Fetch reservation details
    fetch(`/api/reservations/${pnr}/passengers`)
        .then(response => response.json())
        .then(data => {
            // Create and show modal with reservation details
            const modal = new bootstrap.Modal(document.getElementById('reservationDetailsModal'));
            const modalBody = document.getElementById('reservationDetailsBody');
            
            // Format the data for display
            let html = `
                <div class="reservation-details">
                    <h5>Passenger Details</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Seat</th>
                                    <th>Fare</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.forEach(passenger => {
                html += `
                    <tr>
                        <td>${passenger.first_name} ${passenger.last_name}</td>
                        <td>${calculateAge(passenger.date_of_birth)}</td>
                        <td>${passenger.gender}</td>
                        <td>${passenger.coach_type} - ${passenger.seat_number}</td>
                        <td>₹${passenger.fare}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = html;
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading reservation details');
        });
}

function cancelReservation(pnr) {
    if (confirm('Are you sure you want to cancel this reservation?')) {
        fetch(`/cancel-reservation/${pnr}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Reservation cancelled successfully');
                location.reload(); // Refresh the page to update the list
            } else {
                alert(data.message || 'Error cancelling reservation');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error cancelling reservation');
        });
    }
}

// Add Reservation Details Modal to the HTML
document.body.insertAdjacentHTML('beforeend', `
    <div class="modal fade" id="reservationDetailsModal" tabindex="-1" aria-labelledby="reservationDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reservationDetailsModalLabel">Reservation Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reservationDetailsBody">
                    <!-- Content will be dynamically inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
`);

// --- Chat Interface JavaScript ---
document.addEventListener('DOMContentLoaded', function() {
    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    // Function to append a message to the chat box
    function appendMessage(message, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', sender);
        messageElement.textContent = message;
        chatBox.appendChild(messageElement);
        // Scroll to the bottom
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Function to send message to the backend
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
            appendMessage(message, 'user');
            chatInput.value = '';
            chatInput.disabled = true; // Disable input while waiting for response
            sendButton.disabled = true; // Disable button

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                appendMessage(data.reply, 'ai');

            } catch (error) {
                console.error('Error sending message:', error);
                appendMessage('Error communicating with the AI.', 'ai');
            } finally {
                chatInput.disabled = false; // Re-enable input
                sendButton.disabled = false; // Re-enable button
                chatInput.focus(); // Focus input for next message
            }
        }
    }

    // Event listener for the send button
    sendButton.addEventListener('click', sendMessage);

    // Event listener for pressing Enter in the input field
    chatInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default form submission
            sendMessage();
        }
    });

    // Optional: Add a welcome message from the AI when the page loads
    // appendMessage('Hello! How can I help you with your train booking today?', 'ai');
});
</script>

<style>
.seat-map {
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    background: #fff;
}

.coach-label {
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
    color: #0d6efd;
}

.seat-grid {
    display: grid;
    grid-template-columns: repeat(7, auto);
    gap: 5px;
    padding: 5px;
}

.seat {
    width: 35px;
    height: 35px;
    border: 2px solid #ccc;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.seat.available {
    background-color: #fff;
    border-color: #28a745;
}

.seat.booked {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
    cursor: not-allowed;
}

.seat.selected {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    transform: scale(1.1);
}

.seat.ladies {
    background-color: #ff69b4;
    border-color: #ff69b4;
    color: white;
}

.seat.senior {
    background-color: #ffc107;
    border-color: #ffc107;
}

.seat:hover:not(.booked) {
    transform: scale(1.1);
}

.seat-legend {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 14px;
}

.seat-icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid;
    border-radius: 4px;
    margin-right: 5px;
    vertical-align: middle;
}

.seat-icon.available {
    border-color: #28a745;
    background-color: #fff;
}

.seat-icon.booked {
    border-color: #dc3545;
    background-color: #dc3545;
}

.seat-icon.selected {
    border-color: #0d6efd;
    background-color: #0d6efd;
}

.seat-icon.ladies {
    border-color: #ff69b4;
    background-color: #ff69b4;
}

.seat-icon.senior {
    border-color: #ffc107;
    background-color: #ffc107;
}

#availabilityCard {
    transition: all 0.3s ease;
}

.card-title.text-primary {
    margin-bottom: 1rem;
}

.age-badge {
    font-size: 0.8em;
    padding: 0.3em 0.6em;
    margin-left: 0.5em;
}

.aisle {
    width: 20px;
    height: 30px;
}

.seat-info {
    margin-top: 10px;
}

.passenger-card.free-ticket {
    background-color: #e8f5e9;
    border-color: #81c784;
}

.free-ticket .card-header {
    background-color: #c8e6c9;
    border-bottom-color: #81c784;
}

.age-status {
    font-size: 0.9em;
}

.age-status .alert {
    padding: 0.5rem 1rem;
    margin-bottom: 0;
}

.validation-message {
    margin-bottom: 1rem;
}

.validation-message i {
    margin-right: 0.5rem;
}

.passenger-card .alert {
    margin-top: 0.5rem;
}

.passenger-card.free-ticket {
    background-color: #e8f5e9;
    border-color: #81c784;
}

.passenger-card.free-ticket .card-body {
    background-color: rgba(129, 199, 132, 0.1);
}

.modal-body {
    overflow-y: auto;
    /* Add some padding at the bottom in case content goes all the way down */
    padding-bottom: 20px; 
}

.modal-footer {
    position: relative; /* Needed for z-index to work */
    z-index: 1050; /* Ensure it's above most other modal content */
    pointer-events: auto !important; /* Ensure clicks are registered */
}

.modal-footer .btn-primary {
    pointer-events: auto !important; /* Ensure button is clickable */
}

/* Added to ensure modal is on top of everything */
#bookingModal {
    z-index: 2000 !important; /* A very high z-index */
    pointer-events: auto !important; /* Ensure clicks are registered on the modal */
}

/* Ensure the backdrop is below the modal but allows clicks on the modal */
.modal-backdrop {
    z-index: 1999 !important; /* Just below the modal */
    /* Added to make the backdrop transparent */
    background-color: transparent !important;
}

/* Aggressive rule to disable pointer events on everything except the modal when modal is open */
body.modal-open {
    pointer-events: none;
}

body.modal-open #bookingModal,
body.modal-open #bookingModal * {
    pointer-events: auto;
}

/* Basic Chat Interface Styles */
#chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    height: 400px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    background-color: white;
    z-index: 1000; /* Ensure chat is above general page content */
}

#chat-box {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto;
    border-bottom: 1px solid #eee;
}

.chat-message {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 5px;
    max-width: 80%;
}

.chat-message.user {
    background-color: #0d6efd;
    color: white;
    align-self: flex-end;
    margin-left: auto; /* Align to the right */
    border-bottom-right-radius: 0;
}

.chat-message.ai {
    background-color: #e9e9eb;
    color: #333;
    align-self: flex-start;
    margin-right: auto; /* Align to the left */
    border-bottom-left-radius: 0;
}

#chat-input-container {
    display: flex;
    padding: 10px;
}

#chat-input {
    flex-grow: 1;
    margin-right: 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    padding: 8px;
}

#send-button {
    /* Use Bootstrap button styles */
}
</style>
{% endblock %} 